---
title: "{dm} is fantastic!"
description: |
  A quick overview of the {dm} package for working with relational data      models in R
author:
  - name: Harry Fisher
    url: https://hfshr.xyz
date: 05-03-2021
output:
  distill::distill_article:
    self_contained: false
preview: dm.png
draft: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(dm)
```

Sometimes as an R user you may find yourself needing to work with data that is stored in a remote database. 

`dbplyr` allows you to use the majority of dplyr/tidyr functions on a remote table, automagically converting these commands into the necessary sql and returing the result when you call `collect()`. `dm` extends this concept and adds extra functionality for working with the whole database by  




```{r eval = FALSE}
install.packages("dm")

library(dm)

con <- DBI::dbConnect(odbc::odbc(),
                      Driver   = "ODBC Driver 17 for SQL Server",
                      Server   = "localhost",
                      UID      = Sys.getenv("SQL_user"),
                      PWD      = Sys.getenv("SQL_password"),
                      Port     = 1433)

flights <- dm_nycflights13()

DBI::dbSendQuery(con, "CREATE DATABASE nycflights")

copy_dm_to(con, dm = flights, temporary = FALSE)
```

Next I rerun the connection, but this time specifying the newly created nycflights database.

```{r}
con <- DBI::dbConnect(odbc::odbc(),
                      Driver   = "ODBC Driver 17 for SQL Server",
                      Server   = "localhost",
                      Database = "nycflights",
                      UID      = Sys.getenv("SQL_user"),
                      PWD      = Sys.getenv("SQL_password"),
                      Port     = 1433)
```

Now our data is in the database we can begin working with it. To connect to the database and learn the connections, we can use `dm_from_src`. Setting the `learn_keys` argument to `TRUE` means dm will attempt to discover the primary and foreign keys between the tables, however this currently only work with MS SQL databases

```{r}
flights <- dm_from_src(con, learn_keys = TRUE)
```


A really great feature of dm is the ability to plot the database to visulaise the links between tables. We can do this by using the `dm_draw` function

```{r}
dm_draw(flights)
```

Now for some reason, the planes tables should be connected to the flights tables, but when copying the data over during the setup I got an error...We can manually create the links  

```{r}
flights <- flights %>% 
  dm_add_fk(table = flights, columns = tailnum, ref_table = planes)
```

```{r}
dm_draw(flights)
```

